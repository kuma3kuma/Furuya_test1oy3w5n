<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AR Days of Week</title>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    </head>

    <!-- ... head部分は同じ ... -->

<body style="margin: 0; overflow: hidden;">
    <!-- ローディング表示を修正 -->
    <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 9999;">
        <div>Loading Resources...</div>
        <div>カメラの使用を許可してください</div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        id="scene"
        embedded
        gesture-detector
    >
        <!-- ... a-assets と markers は同じ ... -->
    </a-scene>
        
    <script>
        // ローディング処理を改善
        document.addEventListener('DOMContentLoaded', function() {
            const loadingEl = document.getElementById('loading');
            const scene = document.querySelector('a-scene');

            // シーンの読み込み完了時
            scene.addEventListener('loaded', function () {
                console.log('A-Frame scene loaded');
                hideLoading();
            });

            // カメラのセットアップ完了時
            scene.addEventListener('camera-init', function() {
                console.log('Camera initialized');
            });

            // エラー発生時
            scene.addEventListener('camera-error', function(err) {
                console.error('Camera error:', err);
                alert('カメラの初期化に失敗しました。ページをリロードしてカメラの使用を許可してください。');
            });

            // 30秒後にもし読み込みが完了していない場合は強制的に非表示
            setTimeout(hideLoading, 30000);

            function hideLoading() {
                if (loadingEl.style.display !== 'none') {
                    loadingEl.style.display = 'none';
                    console.log('Loading screen hidden');
                }
            }
        });

        // マーカー検出の処理
        const markers = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        markers.forEach(day => {
            const marker = document.querySelector(`a-marker[url="assets/marker_${day}.patt"]`);
            if (marker) {
                // マーカーが見つかったとき
                marker.addEventListener('markerFound', () => {
                    console.log(`Marker ${day} found`);
                    const audio = document.querySelector(`#audio_${day}`);
                    if (audio) {
                        audio.currentTime = 0;
                        audio.play().catch(error => {
                            console.log('Audio playback error:', error);
                        });
                    }
                });
                
                // マーカーが見失われたとき
                marker.addEventListener('markerLost', () => {
                    console.log(`Marker ${day} lost`);
                    const audio = document.querySelector(`#audio_${day}`);
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                });
            }
        });

        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('Error:', e.error);
        });
    </script>
</body>
</html>
