<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AR Days of Week</title>
        <!-- A-Frame と AR.js のバージョンを最新の安定版に更新 -->
        <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <style>
            #loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: white;
                z-index: 9999;
            }
            .ar-only {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 9999;
            }
        </style>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div id="loading">
            <div>Loading...</div>
            <div>カメラの使用を許可してください</div>
        </div>

        <div id="arjs-video"></div>

        <a-scene
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true;"
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

            <a-assets>
                <a-asset-item id="pb_mon" src="assets/pb_mon.glb"></a-asset-item>
                <a-asset-item id="pb_tue" src="assets/pb_tue.glb"></a-asset-item>
                <a-asset-item id="pb_wed" src="assets/pb_wed.glb"></a-asset-item>
                <a-asset-item id="pb_thu" src="assets/pb_thu.glb"></a-asset-item>
                <a-asset-item id="pb_fri" src="assets/pb_fri.glb"></a-asset-item>
                <a-asset-item id="pb_sat" src="assets/pb_sat.glb"></a-asset-item>
                <a-asset-item id="pb_sun" src="assets/pb_sun.glb"></a-asset-item>

                <audio id="audio_mon" src="assets/mon.mp3" preload="auto"></audio>
                <audio id="audio_tue" src="assets/tue.mp3" preload="auto"></audio>
                <audio id="audio_wed" src="assets/wed.mp3" preload="auto"></audio>
                <audio id="audio_thu" src="assets/thu.mp3" preload="auto"></audio>
                <audio id="audio_fri" src="assets/fri.mp3" preload="auto"></audio>
                <audio id="audio_sat" src="assets/sat.mp3" preload="auto"></audio>
                <audio id="audio_sun" src="assets/sun.mp3" preload="auto"></audio>
            </a-assets>

            <!-- マーカー設定を簡略化 -->
            <a-marker preset="pattern" type="pattern" url="assets/marker_mon.patt">
                <a-entity gltf-model="#pb_mon" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-marker preset="pattern" type="pattern" url="assets/marker_tue.patt">
                <a-entity gltf-model="#pb_tue" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-marker preset="pattern" type="pattern" url="assets/marker_wed.patt">
                <a-entity gltf-model="#pb_wed" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-marker preset="pattern" type="pattern" url="assets/marker_thu.patt">
                <a-entity gltf-model="#pb_thu" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-marker preset="pattern" type="pattern" url="assets/marker_fri.patt">
                <a-entity gltf-model="#pb_fri" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-marker preset="pattern" type="pattern" url="assets/marker_sat.patt">
                <a-entity gltf-model="#pb_sat" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-marker preset="pattern" type="pattern" url="assets/marker_sun.patt">
                <a-entity gltf-model="#pb_sun" scale="0.1 0.1 0.1" position="0 0 0"></a-entity>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>

        <script>
            window.onload = function() {
                // シーンの読み込みを確認
                const scene = document.querySelector('a-scene');
                const loading = document.getElementById('loading');

                if (scene.hasLoaded) {
                    loading.style.display = 'none';
                } else {
                    scene.addEventListener('loaded', function () {
                        loading.style.display = 'none';
                    });
                }

                // マーカーのイベント設定
                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                days.forEach(day => {
                    const marker = document.querySelector(`a-marker[url="assets/marker_${day}.patt"]`);
                    if (marker) {
                        marker.addEventListener('markerFound', function() {
                            const audio = document.querySelector(`#audio_${day}`);
                            if (audio) {
                                audio.currentTime = 0;
                                audio.play().catch(function(error) {
                                    console.log(error);
                                });
                            }
                        });

                        marker.addEventListener('markerLost', function() {
                            const audio = document.querySelector(`#audio_${day}`);
                            if (audio) {
                                audio.pause();
                                audio.currentTime = 0;
                            }
                        });
                    }
                });
            };

            // エラーハンドリング
            window.addEventListener('error', function(e) {
                console.error('Error:', e.error);
                alert('エラーが発生しました。ページをリロードしてください。');
            });
        </script>
    </body>
</html>
