<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densityDpi=device-dpi" />
        <title>AR Days of Week</title>
        <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

        <script>
            AFRAME.registerComponent('auto-rotate', {
                schema: {
                    speedX: { type: 'number', default: 0 },
                    speedY: { type: 'number', default: 2 },
                    speedZ: { type: 'number', default: 0 }
                },
                tick: function (time, deltaTime) {
                    const rotation = this.el.object3D.rotation;
                    const delta = deltaTime / 1000;
                    rotation.x += this.data.speedX * delta;
                    rotation.y += this.data.speedY * delta;
                    rotation.z += this.data.speedZ * delta;
                }
            });
        </script>

        <style>
            .message {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 9999;
                text-align: center;
            }
        </style>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div id="message" class="message">マーカーをかざしてください</div>

        <a-scene
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true;"
            embedded
            gesture-detector
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

            <!-- マーカーのみ初期設定 -->
            <a-marker preset="pattern" type="pattern" url="assets/marker_mon.patt" id="marker_mon"></a-marker>
            <a-marker preset="pattern" type="pattern" url="assets/marker_tue.patt" id="marker_tue"></a-marker>
            <a-marker preset="pattern" type="pattern" url="assets/marker_wed.patt" id="marker_wed"></a-marker>
            <a-marker preset="pattern" type="pattern" url="assets/marker_thu.patt" id="marker_thu"></a-marker>
            <a-marker preset="pattern" type="pattern" url="assets/marker_fri.patt" id="marker_fri"></a-marker>
            <a-marker preset="pattern" type="pattern" url="assets/marker_sat.patt" id="marker_sat"></a-marker>
            <a-marker preset="pattern" type="pattern" url="assets/marker_sun.patt" id="marker_sun"></a-marker>

            <a-entity camera></a-entity>
        </a-scene>

        <script>
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const loadedModels = new Set();
            const messageEl = document.getElementById('message');

            // アセットを動的に読み込む関数
            async function loadAssets(day) {
                if (loadedModels.has(day)) return;

                messageEl.textContent = '読み込み中...';

                try {
                    // 3Dモデルの動的読み込み
                    const marker = document.querySelector(`#marker_${day}`);
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gltf-model', `assets/pb_${day}.glb`);
                    entity.setAttribute('scale', '0.2 0.2 0.2');  // スケールを2倍に
                    entity.setAttribute('position', '0 0 0');
                    
                    // 自動回転を追加
                    entity.setAttribute('auto-rotate', {
                        speedX: 0,
                        speedY: 1,
                        speedZ: 0
                    });
                    
                    // ジェスチャーによる操作を追加
                    entity.setAttribute('gesture-handler', {
                        rotationFactor: 10,
                        minScale: 0.1,
                        maxScale: 1.0
                    });

                    marker.appendChild(entity);

                    // 音声の動的読み込み
                    const audio = new Audio(`assets/${day}.mp3`);
                    audio.id = `audio_${day}`;
                    document.body.appendChild(audio);

                    loadedModels.add(day);
                    messageEl.textContent = 'マーカーをかざしてください';
                } catch (error) {
                    console.error('Asset loading error:', error);
                    messageEl.textContent = '読み込みエラー。再試行してください。';
                }
            }

            // マーカーのイベント設定
            days.forEach(day => {
                const marker = document.querySelector(`#marker_${day}`);
                if (marker) {
                    marker.addEventListener('markerFound', async function() {
                        // マーカーが見つかったらアセットを読み込む
                        await loadAssets(day);

                        // 音声再生
                        const audio = document.querySelector(`#audio_${day}`);
                        if (audio) {
                            audio.currentTime = 0;
                            audio.play().catch(console.error);
                        }
                    });

                    marker.addEventListener('markerLost', function() {
                        const audio = document.querySelector(`#audio_${day}`);
                        if (audio) {
                            audio.pause();
                            audio.currentTime = 0;
                        }
                    });
                }
            });

            // シーンの読み込み完了時
            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', function() {
                messageEl.textContent = 'マーカーをかざしてください';
            });

            // エラーハンドリング
            window.addEventListener('error', function(e) {
                console.error('Error:', e.error);
                messageEl.textContent = 'エラーが発生しました。ページを更新してください。';
            });
        </script>
    </body>
</html>
